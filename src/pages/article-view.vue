<template>	
	<section class="post-section">
		<div class="container">
			<el-row :gutter="30">
				<el-col :span="16" class="main">
					<el-row :gutter="20">
						<article class="content-container">
							<div class="content-header">
								<span class="content-category">{{ article.category_name }}</span>
								<h3>{{ article.title }}</h3>
							</div>
							<div class="content-main" v-html="article.html"></div>
						</article>
					</el-row>
				</el-col>
				<el-col :span="8" class="aside">
					<post-topics></post-topics>
					<post-hot></post-hot>
				</el-col>
			</el-row>
		</div>
	</section>
</template>

<script>
import postTopics from '@/components/post-topics.vue'
import postHot from '@/components/post-hot.vue'

export default {
	name: 'articleView',
	components: {
		postTopics,
		postHot
	},
	data() {
		return {
			article: {
		        "likes": [],
		        "_id": "589af8cde9be1c5b21ef8e9c",
		        "title": "Vue 中统一处理 ajax 请求错误",
		        "category": "58481a49d4352863efb5542c",
		        "category_name": "Vue",
		        "content": "通常说, ajax 请求错误有两种, 一种是网络问题或者代码问题所造成的 400, 500错误等, 另外一种是请求参数后端通不过验证, 由后端抛出的错误\n\n第二种根据不同的后端框架或者程序猿又可以分成两种, 一种是直接返回 json, 用一个 特别的 code 来区别正常请求返回的数据, 如:\n```\n{\n  code: -404,\n  message: '这是错误信息',\n  data: '',\n}\n```\n还有一种就是抛出 http 404 之类的, 然后把错误原因放在 header 里.\n\n在组件写调用 ajax时, 通常都是这么写(这里以 axios 为例):\n```javascript\nimport axios from 'axios'\naxios.get('/user?ID=12345')\n  .then(function (response) {\n    if (response.data.code === 200) {\n\t\tconsole.log(response.data)\n\t} else {\n\t\t// 由后端抛出的错误\n\t\talert(response.data.message)\n\t}\n  }).catch(function (error) {\n  \t // 由网络或者服务器抛出的错误\n     alert(error.toString())\n  })\n```\n随着请求越来越多, 这么写也就显得麻烦...所以我们需要封装下, 做一些预处理\n下面代码以 axios 为例:\n\n### 1. 创建 api.js 文件\n\n```javascript\nimport axios from 'axios'\nimport qs from 'qs'\n```\n引入我们需要的两个库, 为什么需要用到 qs, 后面会说到\n\n### 2. 利用拦截器做预处理\n\n请求时的拦截器\n```javascript\naxios.interceptors.request.use(config => {\n    // 这里可以加一些动作, 比如来个进度条开始动作,\n\tNProgress.start()\n    return config\n}, error => {\n    return Promise.reject(error)\n})\n```\n\n请求完成后的拦截器\n```javascript\naxios.interceptors.response.use(response => {\n\treturn response\n}, error => {\n\t// 这里我们把错误信息扶正, 后面就不需要写 catch 了\n\treturn Promise.resolve(error.response)\n})\n```\n这里的`return response`返回的是一个对象, 内容如下:\n```javascript\n{\n  // 服务器提供的响应\n  data: {},\n  // 服务器响应的HTTP状态代码\n  status: 200,\n  // 服务器响应的HTTP状态消息\n  statusText: 'OK',\n  // 服务器响应头\n  headers: {},\n  // axios 的配置\n  config: {}\n}\n```\n\n### 做 api 封装\n这里一般封装两种方法, 一个是 get 请求, 一个是 post 请求, 有其他情况也可以自行添加\n```javascript\nexport default {\n    post(url, data) {\n        return axios({\n            method: 'post', // 请求协议\n            url: url, // 请求的地址\n            data: qs.stringify(data), // post 请求的数据\n            timeout: 30000, // 超时时间, 单位毫秒\n            headers: {\n                'X-Requested-With': 'XMLHttpRequest',\n                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n            }\n        })\n    },\n    get(url, params) {\n        return axios({\n            method: 'get',\n            url: url,\n            params, // get 请求时带的参数\n            timeout: 30000,\n            headers: {\n                'X-Requested-With': 'XMLHttpRequest'\n            }\n        })\n    }\n}\n```\n这里的 data 为什么需要用`qs.stringify(data)`包一下, 主要是配合下面`headers`里的`Content-Type`, 转成表单提交, 让后端可以直接用 $_POST 拿到数据\n这样, 一个大概的封装就完成了\n\n### 4. 数据统一处理\n我们先处理来自网络或者服务器的错误, 定义一个`checkStatus`函数\n```javascript\nfunction checkStatus(response) {\n    // 这里可以加一些动作, 比如来个进度条结束动作\n    NProgress.done()\n\t// 如果 http 状态码正常, 则直接返回数据\n    if (response.status === 200 || response.status === 304) {\n        return response\n\t\t// 这里, 如果不需要除 data 外的其他数据, 可以直接 return response.data, 这样可以让后面的代码精简一些\n    }\n\t// 异常状态下, 把错误信息返回去\n\t// 因为前面我们把错误扶正了, 不然像 404, 500 这样的错误是走不到这里的\n    return {\n        data: {\n            code: -404,\n            message: response.statusText,\n            data: response.statusText,\n        }\n    }\n\t// 如果上面你 return 的是 response.data, 那么这里可以写成\n\t// return {\n\t//\tcode: -404,\n\t//\tmessage: response.statusText,\n\t//\tdata: response.statusText,\n    //}\n}\n```\n再来处理来自程序端的错误, 创建一个`checkCode`的函数\n```javascript\nfunction checkCode(res) {\n\t// 如果状态 code 异常(这里已经包括网络错误, 服务器错误, 后端抛出的错误), 可以弹出一个错误提示, 告诉用户\n    if (res.data.code !== 200) { // 或者是res.code, 视上面你返回的数据来决定\n        alert(res.data.message)\n    }\n    return res\n}\n```\n\n### 5. 最终代码\n```javascript\nimport axios from 'axios'\nimport qs from 'qs'\nimport NProgress from 'nprogress'\n\naxios.interceptors.request.use(config => {\n    NProgress.start()\n    return config\n}, error => {\n    return Promise.reject(error)\n})\n\naxios.interceptors.response.use(response => response, error => Promise.resolve(error.response))\n\nfunction checkStatus(response) {\n    NProgress.done()\n    if (response.status === 200 || response.status === 304) {\n        return response\n    }\n    return {\n        data: {\n            code: -404,\n            message: response.statusText,\n            data: response.statusText,\n        }\n    }\n}\n\nfunction checkCode(res) {\n    if (res.data.code !== 200) {\n        alert(res.data.message)\n    }\n    return res\n}\n\nexport default {\n    post(url, data) {\n        return axios({\n            method: 'post',\n            url,\n            data: qs.stringify(data),\n            timeout: 30000,\n            headers: {\n                'X-Requested-With': 'XMLHttpRequest',\n                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n            }\n        }).then(checkStatus).then(checkCode)\n    },\n    get(url, params) {\n        return axios({\n            method: 'get',\n            url,\n            params,\n            timeout: 30000,\n            headers: {\n                'X-Requested-With': 'XMLHttpRequest'\n            }\n        }).then(checkStatus).then(checkCode)\n    }\n}\n```\n\n### 6. 在组件中使用\n\n```javascript\nimport api from '../api.js' // 改成对应的路径\nexport default {\n  async mounted() {\n\tconst { data: { code, data }} = await api.post('/api/comment/post', {title: 'title'})\n\tif (code === 200) {\n\t\tconsole.log(data)\n\t}\n\tconst { data: { code, data }} = await api.get('/api/comment/get', {page: 1})\n\tif (code === 200) {\n\t\tconsole.log(data)\n\t}\n  }\n}\n```",
		        "html": "<p>通常说, ajax 请求错误有两种, 一种是网络问题或者代码问题所造成的 400, 500错误等, 另外一种是请求参数后端通不过验证, 由后端抛出的错误</p>\n<p>第二种根据不同的后端框架或者程序猿又可以分成两种, 一种是直接返回 json, 用一个 特别的 code 来区别正常请求返回的数据, 如:</p>\n<pre><code>{\n  <span class=\"hljs-attribute\">code</span>: -<span class=\"hljs-number\">404</span>,\n  message: <span class=\"hljs-string\">'这是错误信息'</span>,\n  data: <span class=\"hljs-string\">''</span>,\n}\n</code></pre><p>还有一种就是抛出 http 404 之类的, 然后把错误原因放在 header 里.</p>\n<p>在组件写调用 ajax时, 通常都是这么写(这里以 axios 为例):</p>\n<pre><code class=\"lang-javascript\"><span class=\"hljs-keyword\">import</span> axios <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'axios'</span>\naxios.get(<span class=\"hljs-string\">'/user?ID=12345'</span>)\n  .then(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">response</span>) </span>{\n    <span class=\"hljs-keyword\">if</span> (response.data.code === <span class=\"hljs-number\">200</span>) {\n        <span class=\"hljs-built_in\">console</span>.log(response.data)\n    } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-comment\">// 由后端抛出的错误</span>\n        alert(response.data.message)\n    }\n  }).catch(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">error</span>) </span>{\n       <span class=\"hljs-comment\">// 由网络或者服务器抛出的错误</span>\n     alert(error.toString())\n  })\n</code></pre>\n<p>随着请求越来越多, 这么写也就显得麻烦...所以我们需要封装下, 做一些预处理<br>下面代码以 axios 为例:</p>\n<h3 id=\"1-api-js-\">1. 创建 api.js 文件</h3>\n<pre><code class=\"lang-javascript\"><span class=\"hljs-keyword\">import</span> axios <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'axios'</span>\n<span class=\"hljs-keyword\">import</span> qs <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'qs'</span>\n</code></pre>\n<p>引入我们需要的两个库, 为什么需要用到 qs, 后面会说到</p>\n<h3 id=\"2-\">2. 利用拦截器做预处理</h3>\n<p>请求时的拦截器</p>\n<pre><code class=\"lang-javascript\">axios.interceptors.request.<span class=\"hljs-keyword\">use</span>(config =&gt; {\n    <span class=\"hljs-comment\">// 这里可以加一些动作, 比如来个进度条开始动作,</span>\n    NProgress.start()\n    <span class=\"hljs-keyword\">return</span> config\n}, <span class=\"hljs-built_in\">error</span> =&gt; {\n    <span class=\"hljs-keyword\">return</span> Promise.reject(<span class=\"hljs-built_in\">error</span>)\n})\n</code></pre>\n<p>请求完成后的拦截器</p>\n<pre><code class=\"lang-javascript\">axios.interceptors.response.<span class=\"hljs-keyword\">use</span>(response =&gt; {\n    <span class=\"hljs-keyword\">return</span> response\n}, <span class=\"hljs-built_in\">error</span> =&gt; {\n    <span class=\"hljs-comment\">// 这里我们把错误信息扶正, 后面就不需要写 catch 了</span>\n    <span class=\"hljs-keyword\">return</span> Promise.resolve(<span class=\"hljs-built_in\">error</span>.response)\n})\n</code></pre>\n<p>这里的<code>return response</code>返回的是一个对象, 内容如下:</p>\n<pre><code class=\"lang-javascript\">{\n  <span class=\"hljs-comment\">// 服务器提供的响应</span>\n  <span class=\"hljs-attribute\">data</span>: {},\n  <span class=\"hljs-comment\">// 服务器响应的HTTP状态代码</span>\n  <span class=\"hljs-attribute\">status</span>: <span class=\"hljs-number\">200</span>,\n  <span class=\"hljs-comment\">// 服务器响应的HTTP状态消息</span>\n  <span class=\"hljs-attribute\">statusText</span>: <span class=\"hljs-string\">'OK'</span>,\n  <span class=\"hljs-comment\">// 服务器响应头</span>\n  <span class=\"hljs-attribute\">headers</span>: {},\n  <span class=\"hljs-comment\">// axios 的配置</span>\n  <span class=\"hljs-attribute\">config</span>: {}\n}\n</code></pre>\n<h3 id=\"-api-\">做 api 封装</h3>\n<p>这里一般封装两种方法, 一个是 get 请求, 一个是 post 请求, 有其他情况也可以自行添加</p>\n<pre><code class=\"lang-javascript\"><span class=\"hljs-selector-tag\">export</span> <span class=\"hljs-selector-tag\">default</span> {\n    <span class=\"hljs-selector-tag\">post</span>(url, data) {\n        <span class=\"hljs-selector-tag\">return</span> <span class=\"hljs-selector-tag\">axios</span>({\n            <span class=\"hljs-attribute\">method</span>: <span class=\"hljs-string\">'post'</span>, <span class=\"hljs-comment\">// 请求协议</span>\n            <span class=\"hljs-attribute\">url</span>: url, <span class=\"hljs-comment\">// 请求的地址</span>\n            <span class=\"hljs-attribute\">data</span>: qs.stringify(data), <span class=\"hljs-comment\">// post 请求的数据</span>\n            <span class=\"hljs-attribute\">timeout</span>: <span class=\"hljs-number\">30000</span>, <span class=\"hljs-comment\">// 超时时间, 单位毫秒</span>\n            <span class=\"hljs-attribute\">headers</span>: {\n                <span class=\"hljs-string\">'X-Requested-With'</span>: <span class=\"hljs-string\">'XMLHttpRequest'</span>,\n                <span class=\"hljs-string\">'Content-Type'</span>: <span class=\"hljs-string\">'application/x-www-form-urlencoded; charset=UTF-8'</span>\n            }\n        })\n    },\n    <span class=\"hljs-selector-tag\">get</span>(url, params) {\n        <span class=\"hljs-selector-tag\">return</span> <span class=\"hljs-selector-tag\">axios</span>({\n            <span class=\"hljs-attribute\">method</span>: <span class=\"hljs-string\">'get'</span>,\n            <span class=\"hljs-attribute\">url</span>: url,\n            params, <span class=\"hljs-comment\">// get 请求时带的参数</span>\n            <span class=\"hljs-attribute\">timeout</span>: <span class=\"hljs-number\">30000</span>,\n            <span class=\"hljs-attribute\">headers</span>: {\n                <span class=\"hljs-string\">'X-Requested-With'</span>: <span class=\"hljs-string\">'XMLHttpRequest'</span>\n            }\n        })\n    }\n}\n</code></pre>\n<p>这里的 data 为什么需要用<code>qs.stringify(data)</code>包一下, 主要是配合下面<code>headers</code>里的<code>Content-Type</code>, 转成表单提交, 让后端可以直接用 $_POST 拿到数据<br>这样, 一个大概的封装就完成了</p>\n<h3 id=\"4-\">4. 数据统一处理</h3>\n<p>我们先处理来自网络或者服务器的错误, 定义一个<code>checkStatus</code>函数</p>\n<pre><code class=\"lang-javascript\">function checkStatus(response) {\n    <span class=\"hljs-comment\">// 这里可以加一些动作, 比如来个进度条结束动作</span>\n    NProgress.done()\n    <span class=\"hljs-comment\">// 如果 http 状态码正常, 则直接返回数据</span>\n    <span class=\"hljs-keyword\">if</span> (response.status === <span class=\"hljs-number\">200</span> || response.status === <span class=\"hljs-number\">304</span>) {\n        <span class=\"hljs-keyword\">return</span> response\n        <span class=\"hljs-comment\">// 这里, 如果不需要除 data 外的其他数据, 可以直接 return response.data, 这样可以让后面的代码精简一些</span>\n    }\n    <span class=\"hljs-comment\">// 异常状态下, 把错误信息返回去</span>\n    <span class=\"hljs-comment\">// 因为前面我们把错误扶正了, 不然像 404, 500 这样的错误是走不到这里的</span>\n    <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-keyword\">data</span>: {\n            code: <span class=\"hljs-number\">-404</span>,\n            message: response.statusText,\n            <span class=\"hljs-keyword\">data</span>: response.statusText,\n        }\n    }\n    <span class=\"hljs-comment\">// 如果上面你 return 的是 response.data, 那么这里可以写成</span>\n    <span class=\"hljs-comment\">// return {</span>\n    <span class=\"hljs-comment\">//    code: -404,</span>\n    <span class=\"hljs-comment\">//    message: response.statusText,</span>\n    <span class=\"hljs-comment\">//    data: response.statusText,</span>\n    <span class=\"hljs-comment\">//}</span>\n}\n</code></pre>\n<p>再来处理来自程序端的错误, 创建一个<code>checkCode</code>的函数</p>\n<pre><code class=\"lang-javascript\">function checkCode(res) {\n    <span class=\"hljs-comment\">// 如果状态 code 异常(这里已经包括网络错误, 服务器错误, 后端抛出的错误), 可以弹出一个错误提示, 告诉用户</span>\n    <span class=\"hljs-keyword\">if</span> (res<span class=\"hljs-selector-class\">.data</span><span class=\"hljs-selector-class\">.code</span> !== <span class=\"hljs-number\">200</span>) { <span class=\"hljs-comment\">// 或者是res.code, 视上面你返回的数据来决定</span>\n        alert(res<span class=\"hljs-selector-class\">.data</span><span class=\"hljs-selector-class\">.message</span>)\n    }\n    return res\n}\n</code></pre>\n<h3 id=\"5-\">5. 最终代码</h3>\n<pre><code class=\"lang-javascript\"><span class=\"hljs-keyword\">import</span> axios <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'axios'</span>\n<span class=\"hljs-keyword\">import</span> qs <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'qs'</span>\n<span class=\"hljs-keyword\">import</span> NProgress <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'nprogress'</span>\n\naxios.interceptors.request.use(<span class=\"hljs-function\"><span class=\"hljs-params\">config</span> =&gt;</span> {\n    NProgress.start()\n    <span class=\"hljs-keyword\">return</span> config\n}, error =&gt; {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">Promise</span>.reject(error)\n})\n\naxios.interceptors.response.use(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> response, error =&gt; <span class=\"hljs-built_in\">Promise</span>.resolve(error.response))\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">checkStatus</span>(<span class=\"hljs-params\">response</span>) </span>{\n    NProgress.done()\n    <span class=\"hljs-keyword\">if</span> (response.status === <span class=\"hljs-number\">200</span> || response.status === <span class=\"hljs-number\">304</span>) {\n        <span class=\"hljs-keyword\">return</span> response\n    }\n    <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-attr\">data</span>: {\n            <span class=\"hljs-attr\">code</span>: <span class=\"hljs-number\">-404</span>,\n            <span class=\"hljs-attr\">message</span>: response.statusText,\n            <span class=\"hljs-attr\">data</span>: response.statusText,\n        }\n    }\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">checkCode</span>(<span class=\"hljs-params\">res</span>) </span>{\n    <span class=\"hljs-keyword\">if</span> (res.data.code !== <span class=\"hljs-number\">200</span>) {\n        alert(res.data.message)\n    }\n    <span class=\"hljs-keyword\">return</span> res\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n    post(url, data) {\n        <span class=\"hljs-keyword\">return</span> axios({\n            <span class=\"hljs-attr\">method</span>: <span class=\"hljs-string\">'post'</span>,\n            url,\n            <span class=\"hljs-attr\">data</span>: qs.stringify(data),\n            <span class=\"hljs-attr\">timeout</span>: <span class=\"hljs-number\">30000</span>,\n            <span class=\"hljs-attr\">headers</span>: {\n                <span class=\"hljs-string\">'X-Requested-With'</span>: <span class=\"hljs-string\">'XMLHttpRequest'</span>,\n                <span class=\"hljs-string\">'Content-Type'</span>: <span class=\"hljs-string\">'application/x-www-form-urlencoded; charset=UTF-8'</span>\n            }\n        }).then(checkStatus).then(checkCode)\n    },\n    get(url, params) {\n        <span class=\"hljs-keyword\">return</span> axios({\n            <span class=\"hljs-attr\">method</span>: <span class=\"hljs-string\">'get'</span>,\n            url,\n            params,\n            <span class=\"hljs-attr\">timeout</span>: <span class=\"hljs-number\">30000</span>,\n            <span class=\"hljs-attr\">headers</span>: {\n                <span class=\"hljs-string\">'X-Requested-With'</span>: <span class=\"hljs-string\">'XMLHttpRequest'</span>\n            }\n        }).then(checkStatus).then(checkCode)\n    }\n}\n</code></pre>\n<h3 id=\"6-\">6. 在组件中使用</h3>\n<pre><code class=\"lang-javascript\"><span class=\"hljs-keyword\">import</span> api <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'../api.js'</span> <span class=\"hljs-comment\">// 改成对应的路径</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n  <span class=\"hljs-keyword\">async</span> mounted() {\n    <span class=\"hljs-keyword\">const</span> { <span class=\"hljs-attr\">data</span>: { code, data }} = <span class=\"hljs-keyword\">await</span> api.post(<span class=\"hljs-string\">'/api/comment/post'</span>, {<span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">'title'</span>})\n    <span class=\"hljs-keyword\">if</span> (code === <span class=\"hljs-number\">200</span>) {\n        <span class=\"hljs-built_in\">console</span>.log(data)\n    }\n    <span class=\"hljs-keyword\">const</span> { <span class=\"hljs-attr\">data</span>: { code, data }} = <span class=\"hljs-keyword\">await</span> api.get(<span class=\"hljs-string\">'/api/comment/get'</span>, {<span class=\"hljs-attr\">page</span>: <span class=\"hljs-number\">1</span>})\n    <span class=\"hljs-keyword\">if</span> (code === <span class=\"hljs-number\">200</span>) {\n        <span class=\"hljs-built_in\">console</span>.log(data)\n    }\n  }\n}\n</code></pre>\n",
		        "visit": 17551,
		        "like": 10,
		        "comment_count": 10,
		        "creat_date": "2017-02-08 18:02:33",
		        "update_date": "2017-03-04 14:19:20",
		        "is_delete": 0,
		        "timestamp": 1486551245,
		        "__v": 0,
		        "like_status": false
		    }
		}
	}
} 
</script>